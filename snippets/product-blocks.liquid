{%- comment -%}
  Pass in:
  - blocks: section's blocks
  - prod: product object
  - featured_media
  - aspect_ratio
  - current_variant
  - is_quick: boolean to indicate if we are rendering quick product or not. Some sections omitted if true
  - is_featured: boolean to indicate if we are rendering featured product or not.
  - column (optional): "left" or "right" to filter by "column_placement"
  - price_content_type: "price" or "custom" or "hide" after checking both $0 and sold out pricing display settings
  - custom_price_content: the translation to populate price if sold out or free, depending on logic checks and settings
{%- endcomment -%}
{%- capture product_url -%}{{ shop.url | append: prod.url }}{%- endcapture -%}

{%- for block in blocks -%}
  {% assign renderBlock = false %}
  {% if column == block.settings.column_placement
    or column == 'right'
    and block.settings.column_placement == blank
    or column == blank
  %}
    {% assign renderBlock = true %}
  {% endif %}

  {% if renderBlock == true %}
    {%- case block.type -%}
      {%- when '@app' -%}
        {% render block %}

      {%- when 'product_header' -%}
        {% if is_quick %}<div class="quick-product--header-block-wrap">{% endif %}
        {%-
          render 'product-block-header' with
          product: prod,
          block: block,
          block_settings: block.settings,
          current_variant: current_variant,
          is_quick: is_quick,
          is_featured: is_featured,
          featured_media: featured_media,
          price_content_type: price_content_type,
          custom_price_content: custom_price_content
        -%}
        {% if is_quick %}</div>{% endif %}
      {%- when 'spacer' -%}
        <div
          class="product-block-spacer product__block product__block--medium"
          style="height: {{ block.settings.space }}px"
          {{ block.shopify_attributes }}
        ></div>

      {%- when 'variant_picker' -%}
        {%- if prod != blank -%}
          {%-
            render 'product-block-variant-picker',
            product: prod,
            block: block,
            block_settings: block.settings,
            current_variant: current_variant,
            use_variant_images: settings.use_variant_image_swatches,
            show_siblings: settings.enable_product_sibling_swatches
          -%}
        {%- endif -%}

      {%- when 'quantity_selector' -%}
        {%- if prod != blank -%}
          {%-
            render 'product-block-quantity-selector' with
            product: prod,
            block: block,
            block_settings: block.settings,
          -%}
        {%- endif -%}

      {%- when 'custom_option' -%}
        {%-
          render 'product-block-custom-option',
          block: block,
          field_type: block.settings.field_type,
        -%}
      {% when 'custom_options_set' %}
        {% liquid
            case settings.swatch_shape
              when 'rectangle'
                case block.settings.swatch_size
                  when 'large'
                    assign swatch_width = 72
                  when 'medium'
                    assign swatch_width = 60
                  else
                    assign swatch_width = 44
                endcase
              else
                case block_settings.swatch_size
                  when 'large'
                    assign swatch_width = 48
                  when 'medium'
                    assign swatch_width = 38
                  else
                    assign swatch_width = 30
                endcase
            endcase

          capture swatch_style
            echo '--swatch-width: [[sw]]px;' | replace: '[[sw]]', swatch_width
            echo '--swatch-image-fit: [[sif]];' | replace: '[[sif]]', settings.swatch_image_fit
          endcapture
        %}

        {% if product.metafields.custom.custom_options.value != blank %}
          <script src="https://unpkg.com/@popperjs/core@2" defer></script>
          <script src="https://unpkg.com/tippy.js@6" defer></script>
          <script src="{{ 'custom-option-sets.js' | asset_url }}" defer></script>
        {% endif %}
        
        {% for option in product.metafields.custom.custom_options.value %}
          <div
            class="product__controls-group product__controls-set product__block product__block--medium"
            {{ block.shopify_attributes }}
          >
            <div class="product__label-wrapper">
              <label class="product__label fs-body-75">
                {{ option.option_name }}:
                <span class="t-opacity-70" data-custom-label-value>{{ option.items[0].value.name }}</span>
              </label>
            </div>
            <div class="product__color-swatches" style="{{ swatch_style }}">
              <div class="product__color-swatches--inner">
                {% for item in option.items.value %}
                  <div>
                    <input
                      type="radio"
                      id="custom-{{ option.option_name | handleize }}-{{ item.name | handleize }}"
                      name="properties[{{ option.option_name }}]"
                      {% if forloop.first %}
                        checked="checked"
                      {% endif %}
                      class="visually-hidden"
                      value="{{ item.name }}"
                      form="product_form_{{ product.id }}"
                    >
                    <label data-shape="{{ settings.swatch_shape }}"
                      data-size="{{ swatch_size }}"
                      class="
                        product__color-swatch
                        product__color-swatch--sibling-product
                        {% if sibling_product.id == prod.id %}
                          selected
                        {% endif %}
                      "
                      data-image="{{ item.image | image_url: width: item.image.width }}"
                      for="custom-{{ option.option_name | handleize }}-{{ item.name | handleize }}"
                      style="{{ swatch_background_style }}">
                      {{ item.image | image_url: width: item.image.width | image_tag: alt: item.name, loading: 'lazy', role: 'presentation' }}
                    </label>
                    <div class="product__custom-option-content-inner">
                      <span class="fs-body-75 t-opacity-70">{{ item.name }}</span>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      {%- when 'buy_buttons' -%}
        {%- if prod != blank -%}
          {%-
            render 'product-block-buy-buttons' with
            prod: prod,
            block: block,
            blocks: blocks,
            block_settings: block.settings,
            current_variant: current_variant,
            featured_media: featured_media,
            aspect_ratio: aspect_ratio,
            price_content_type: price_content_type,
            custom_price_content: custom_price_content
          -%}
        {%- else -%}
          <div class="product-form">
            <div class="product-form__controls-group product-form__controls-group--submit">
              <button
                type="button"
                aria-disabled="true"
                disabled
                class="product-form__cart-submit btn btn--medium btn--full"
              >
                <span>
                  {{ 'products.product.add_to_cart' | t }}
                </span>
              </button>
            </div>
          </div>
        {%- endif -%}

      {%- when 'description' -%}
        {%-
          render 'product-block-description' with
          product: prod,
          block: block,
          block_settings: block.settings,
        -%}

      {%- when 'product_callouts' -%}
        {%- render 'product-block-callouts' with block: block, block_settings: block.settings %}

      {%- when 'product_callouts_mini' -%}
        {%- render 'product-block-callouts-mini' with block: block, block_settings: block.settings %}

      {%- when 'text' -%}
        {%
          render 'product-block-text' with
          content: block.settings.text,
          block_settings: block.settings,
          block: block,
        %}

      {%- when 'share' -%}
        {%- if prod != blank -%}
          {%- liquid
            assign share_alignment = 'left-below'

            if is_quick or is_featured
              assign share_alignment = 'left-above'
            endif
          -%}

          <div class="product-block-social-share product__block product__block--medium" {{ block.shopify_attributes }}>
            {% render 'social-share',
              url: product_url,
              title: product.title,
              image: product.featured_image,
              alignment: share_alignment
            %}
          </div>
        {%- endif -%}

      {%- when 'inventory-counter' -%}
        {%- if prod != blank -%}
          {%-
            render 'inventory-counter' with
            product: prod,
            block: block,
            block_settings: block.settings,
            current_variant: current_variant,
          -%}
        {%- endif -%}

      {%- when 'accordion' -%}
        {%-
          render 'product-block-accordion',
          block: block,
          block_settings: block.settings,
          heading: block.settings.heading,
          content: block.settings.content,
        -%}

      {%- when 'custom_liquid' -%}
        {%- unless block.settings.custom_liquid == blank -%}
          <div class="product-block-custom-liquid product__block product__block--medium" {{ block.shopify_attributes }}>
            {{ block.settings.custom_liquid }}
          </div>
        {%- endunless -%}

      {%- when 'information_popup' -%}
        {%- assign popup_modal_page = pages[block.settings.popup_page] -%}

        {%- if block.settings.popup_text != blank and popup_modal_page.content != blank -%}
          {%
            render 'product-block-information-popup' with
            block: block,
            popup_page_target: block.settings.popup_page,
            popup_page: popup_modal_page,
            icon: block.settings.popup_icon,
            custom_icon_image: block.settings.custom_icon_image,
            text: block.settings.popup_text
          %}
        {%- endif -%}
      {%- when 'popup' -%}
        {%- render 'product-block-popup' with
          block: block,
          block_settings: block.settings
          heading: block.settings.title,
          content: block.settings.content,
        -%}
      {%- when 'featured_products' -%}
        {%- render 'product-block-featured-products', block: block, product: prod -%}

      {%- when 'image' -%}
        <div
          class="
            product-block-image
            product__block
            product__block--medium
          "
        >
          {%-
            render 'image-block' with
            shopify_attributes: block.shopify_attributes,
            wrapper_class: 'product-block-image__text-container-image  section-blocks__image',
            image: block.settings.image,
            width: block.settings.image_size,
            mobile_width: block.settings.image_size_mobile,
            break_to_mobile_at: '720',
            align: block.settings.alignment,
          -%}
        </div>

      {%- when 'secure_payment' -%}
        {%-
          render 'product-block-secure-payment',
          product: prod,
          block: block,
          block_settings: block.settings,
        -%}
    {%- endcase -%}
  {% endif %}
{%- endfor -%}
